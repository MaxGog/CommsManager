<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CommsManager.Maui.Views.OrdersPage"
             xmlns:viewmodels="clr-namespace:CommsManager.Maui.ViewModels"
             xmlns:models="clr-namespace:CommsManager.Maui.Data.Models"
             xmlns:converters="clr-namespace:CommsManager.Maui.Converters"
             Title="Заказы"
             x:DataType="viewmodels:OrdersViewModel">

    <ContentPage.BindingContext>
        <viewmodels:OrdersViewModel/>
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <converters:OrderStatusColorConverter x:Key="StatusColorConverter"/>
        <converters:DateTimeFormatConverter x:Key="DateTimeConverter"/>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto"
          Padding="10"
          RowSpacing="10">

        <Frame Grid.Row="0"
               CornerRadius="10"
               Padding="10"
               BorderColor="LightGray"
               BackgroundColor="#F8F9FA">
            <VerticalStackLayout Spacing="10">

                <Grid ColumnDefinitions="*,Auto">
                    <Entry Grid.Column="0"
                           Text="{Binding SearchText}"
                           Placeholder="Поиск заказов..."
                           ReturnCommand="{Binding ApplyFiltersCommand}">
                        <Entry.Behaviors>
                            <CommunityToolkit.Maui.Behaviors.EventToCommandBehavior
                                EventName="TextChanged"
                                Command="{Binding ApplyFiltersCommand}"/>
                        </Entry.Behaviors>
                    </Entry>

                    <Button Grid.Column="1"
                            Text="Очистить"
                            Command="{Binding ClearFiltersCommand}"
                            WidthRequest="80"
                            Margin="5,0,0,0"/>
                </Grid>

                <Grid ColumnDefinitions="*,*"
                        ColumnSpacing="10">
                    <Picker Grid.Column="0"
                            Title="Статус"
                            ItemsSource="{Binding StatusOptions}"
                            SelectedItem="{Binding SelectedStatus}">
                        <Picker.Behaviors>
                            <CommunityToolkit.Maui.Behaviors.EventToCommandBehavior
                                EventName="SelectedIndexChanged"
                                Command="{Binding ApplyFiltersCommand}"/>
                        </Picker.Behaviors>
                    </Picker>

                    <DatePicker Grid.Column="1"
                                Date="{Binding SelectedDate}"
                                Format="dd.MM.yyyy">
                        <DatePicker.Behaviors>
                            <CommunityToolkit.Maui.Behaviors.EventToCommandBehavior
                                EventName="DateSelected"
                                Command="{Binding ApplyFiltersCommand}"/>
                        </DatePicker.Behaviors>
                    </DatePicker>
                </Grid>
            </VerticalStackLayout>
        </Frame>

        <Frame Grid.Row="1"
               CornerRadius="10"
               Padding="10"
               BackgroundColor="#E3F2FD">
            <HorizontalStackLayout Spacing="15">
                <Label Text="{Binding Orders.Count, StringFormat='Всего: {0}'}"
                       FontSize="14"/>
                <Label Text="{Binding Orders.Where(o => o.Status == 'New').Count(), StringFormat='Новых: {0}'}"
                       FontSize="14"
                       TextColor="Green"/>
                <Label Text="{Binding Orders.Where(o => o.Status == 'InProgress').Count(), StringFormat='В работе: {0}'}"
                       FontSize="14"
                       TextColor="Orange"/>
                <Label Text="{Binding Orders.Where(o => o.IsOverdue).Count(), StringFormat='Просрочено: {0}'}"
                       FontSize="14"
                       TextColor="Red"/>
            </HorizontalStackLayout>
        </Frame>

        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding LoadOrdersCommand}">

            <CollectionView ItemsSource="{Binding Orders}"
                    SelectionMode="None">

                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center"
                            HorizontalOptions="Center"
                            Spacing="20">
                        <Image Source="empty_orders.png"
                            HeightRequest="100"
                            WidthRequest="100"/>
                        <Label Text="Заказов пока нет"
                            FontSize="16"
                            HorizontalOptions="Center"/>
                        <Button Text="Создать первый заказ"
                            Command="{Binding AddOrderCommand}"
                            HorizontalOptions="Center"/>
                    </StackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:LocalOrder">
                        <Grid Padding="10,5"
                            ColumnDefinitions="Auto,*,Auto"
                            RowDefinitions="Auto,Auto,Auto"
                            RowSpacing="3"
                            BackgroundColor="White"
                            Margin="0,0,0,5">

                            <Frame Grid.Row="0"
                                Grid.Column="0"
                                Grid.RowSpan="3"
                                CornerRadius="5"
                                WidthRequest="5"
                                Margin="0"
                                Padding="0"
                                BackgroundColor="{Binding Status, Converter={StaticResource StatusColorConverter}}"/>

                            <StackLayout Grid.Row="0"
                                Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="10">
                                <Label Text="{Binding Title}"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    LineBreakMode="TailTruncation"/>
                                <Label Text="{Binding PriceAmount, StringFormat='{0:C}'}"
                                    FontSize="14"
                                    TextColor="Green"
                                    FontAttributes="Bold"/>
                            </StackLayout>

                            <Label Grid.Row="1"
                                Grid.Column="1"
                                Text="{Binding Description}"
                                FontSize="12"
                                TextColor="Gray"
                                LineBreakMode="TailTruncation"
                                MaxLines="1"/>

                            <HorizontalStackLayout Grid.Row="2"
                                Grid.Column="1"
                                Spacing="15">
                                <Label Text="{Binding Deadline, Converter={StaticResource DateTimeConverter}, StringFormat='До: {0}'}"
                                    FontSize="11"/>
                                <Label Text="{Binding CustomerName, StringFormat='Клиент: {0}'}"
                                    FontSize="11"/>
                            </HorizontalStackLayout>

                            <VerticalStackLayout Grid.Row="0"
                                Grid.Column="2"
                                Grid.RowSpan="3"
                                                VerticalOptions="Center"
                                                Spacing="5">
                                <ImageButton Source="edit.png"
                                    HeightRequest="30"
                                    WidthRequest="30"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:OrdersViewModel}}, 
                                                    Path=EditOrderCommand}"
                                    CommandParameter="{Binding .}"/>
                                <Label Text="{Binding Status}"
                                    FontSize="10"
                                    TextColor="{Binding Status, Converter={StaticResource StatusColorConverter}}"
                                    HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>

                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <Button Grid.Row="3"
            Text="Новый заказ"
            Command="{Binding AddOrderCommand}"
            BackgroundColor="#2b0b98"
            TextColor="White"
            CornerRadius="10"
            HeightRequest="50"
            FontSize="16"/>

    </Grid>
</ContentPage>