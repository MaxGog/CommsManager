<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CommsManager.Maui.Views.ArtistsPage"
             xmlns:viewmodels="clr-namespace:CommsManager.Maui.ViewModels"
             Title="Художники">

    <ContentPage.BindingContext>
        <viewmodels:ArtistsViewModel/>
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*,Auto"
          Padding="10"
          RowSpacing="10">

        <Frame Grid.Row="0"
               CornerRadius="10"
               Padding="5"
               BorderColor="LightGray">
            <Grid ColumnDefinitions="*,Auto">
                <Entry Grid.Column="0"
                       Text="{Binding SearchText}"
                       Placeholder="Поиск художников..."
                       ReturnCommand="{Binding SearchCommand}">
                    <Entry.Behaviors>
                        <CommunityToolkit.Maui.Behaviors.EventToCommandBehavior
                            EventName="TextChanged"
                            Command="{Binding SearchCommand}"/>
                    </Entry.Behaviors>
                </Entry>

                <Button Grid.Column="1"
                        Text="Поиск"
                        Command="{Binding SearchCommand}"
                        WidthRequest="80"
                        Margin="5,0,0,0"/>
            </Grid>
        </Frame>

        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding LoadArtistsCommand}">

            <ScrollView>
                <VerticalStackLayout Spacing="15">

                    <CollectionView ItemsSource="{Binding Artists}"
                                    SelectionMode="Single"
                                    SelectedItem="{Binding SelectedArtist}">

                        <CollectionView.EmptyView>
                            <StackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Spacing="20">
                                <Image Source="empty_artists.png"
                                       HeightRequest="100"
                                       WidthRequest="100"/>
                                <Label Text="Художников пока нет"
                                       FontSize="16"
                                       HorizontalOptions="Center"/>
                                <Button Text="Добавить первого художника"
                                        Command="{Binding AddArtistCommand}"
                                        HorizontalOptions="Center"/>
                            </StackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="10"
                                      ColumnDefinitions="Auto,*,Auto,Auto"
                                      RowSpacing="5">

                                    <Frame Grid.Column="0"
                                           CornerRadius="20"
                                           HeightRequest="40"
                                           WidthRequest="40"
                                           BackgroundColor="#FF6B8B">
                                        <Label Text="{Binding Name, StringFormat='{0}{1}'}"
                                               TextColor="White"
                                               FontSize="16"
                                               HorizontalTextAlignment="Center"
                                               VerticalTextAlignment="Center"/>
                                    </Frame>

                                    <StackLayout Grid.Column="1"
                                                 VerticalOptions="Center"
                                                 Spacing="2">
                                        <Label Text="{Binding Name}"
                                               FontSize="16"
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding Description}"
                                               FontSize="12"
                                               TextColor="Gray"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1"/>
                                    </StackLayout>

                                    <Button Grid.Column="2"
                                            Text="Комиссии"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ArtistsViewModel}}, 
                                                              Path=ViewCommissionsCommand}"
                                            CommandParameter="{Binding .}"
                                            HeightRequest="30"/>

                                    <VerticalStackLayout Grid.Column="3"
                                                         VerticalOptions="Center"
                                                         Spacing="5">
                                        <ImageButton Source="edit.png"
                                                     HeightRequest="30"
                                                     WidthRequest="30"
                                                     Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ArtistsViewModel}}, 
                                                                       Path=EditArtistCommand}"
                                                     CommandParameter="{Binding .}"/>
                                    </VerticalStackLayout>

                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Frame IsVisible="{Binding Commissions.Count, Converter={StaticResource CountToVisibilityConverter}}"
                           CornerRadius="10"
                           Padding="10"
                           BackgroundColor="#FFF3E0">

                        <VerticalStackLayout Spacing="10">
                            <Label Text="Комиссии художника"
                                   FontSize="16"
                                   FontAttributes="Bold"/>

                            <CollectionView ItemsSource="{Binding Commissions}"
                                            HeightRequest="200">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="5"
                                              ColumnDefinitions="*,Auto">
                                            <StackLayout Grid.Column="0">
                                                <Label Text="{Binding Name}"
                                                       FontSize="14"/>
                                                <Label Text="{Binding Price}"
                                                       FontSize="12"
                                                       TextColor="Green"/>
                                            </StackLayout>
                                            <Button Grid.Column="1"
                                                    Text="✎"
                                                    WidthRequest="30"
                                                    HeightRequest="30"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <Button Text="Добавить комиссию"
                                    Command="{Binding AddCommissionCommand}"
                                    BackgroundColor="#FF6B8B"
                                    TextColor="White"/>
                        </VerticalStackLayout>
                    </Frame>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <Button Grid.Row="2"
                Text="Добавить художника"
                Command="{Binding AddArtistCommand}"
                BackgroundColor="#FF6B8B"
                TextColor="White"
                CornerRadius="10"
                HeightRequest="50"
                FontSize="16"/>

    </Grid>
</ContentPage>