<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CommsManager.Maui.Views.CustomersPage"
             xmlns:viewmodels="clr-namespace:CommsManager.Maui.ViewModels"
             Title="Клиенты"
             x:DataType="viewmodels:CustomersViewModel">

    <ContentPage.BindingContext>
        <viewmodels:CustomersViewModel/>
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*,Auto"
        Padding="10"
        RowSpacing="10">

        <Frame Grid.Row="0"
            CornerRadius="10"
            Padding="5"
            BorderColor="LightGray">
            <Grid ColumnDefinitions="*,Auto">
                <Entry Grid.Column="0"
                    Text="{Binding SearchText}"
                    Placeholder="Поиск клиентов..."
                    ReturnCommand="{Binding SearchCommand}">
                    <Entry.Behaviors>
                        <CommunityToolkit.Maui.Behaviors.EventToCommandBehavior
                            EventName="TextChanged"
                            Command="{Binding SearchCommand}"/>
                    </Entry.Behaviors>
                </Entry>

                <Button Grid.Column="1"
                    Text="Поиск"
                    Command="{Binding SearchCommand}"
                    WidthRequest="80"
                    Margin="5,0,0,0"/>
            </Grid>
        </Frame>

        <RefreshView Grid.Row="1"
            IsRefreshing="{Binding IsLoading}"
            Command="{Binding LoadCustomersCommand}">

            <CollectionView ItemsSource="{Binding Customers}"
                SelectionMode="None">

                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center"
                        HorizontalOptions="Center"
                        Spacing="20">
                        <Image Source="empty_customers.png"
                            HeightRequest="100"
                            WidthRequest="100"/>
                        <Label Text="Клиентов пока нет"
                            FontSize="16"
                            HorizontalOptions="Center"/>
                        <Button Text="Добавить первого клиента"
                            Command="{Binding AddCustomerCommand}"
                            HorizontalOptions="Center"/>
                    </StackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:LocalCustomer">
                        <Grid Padding="10"
                            ColumnDefinitions="Auto,*,Auto,Auto"
                            RowSpacing="5">

                            <Frame Grid.Column="0"
                                CornerRadius="20"
                                HeightRequest="40"
                                WidthRequest="40"
                                BackgroundColor="#2b0b98">
                                <Label Text="{Binding Name, StringFormat='{0}{1}'}"
                                    TextColor="White"
                                    FontSize="16"
                                    HorizontalTextAlignment="Center"
                                    VerticalTextAlignment="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding Name, Converter={StaticResource FirstLetterConverter}}"
                                                FontAttributes="Bold"/>
                                            <Span Text="{Binding Name, Converter={StaticResource SecondLetterConverter}}"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </Frame>

                            <StackLayout Grid.Column="1"
                                VerticalOptions="Center"
                                Spacing="2">
                                <Label Text="{Binding Name}"
                                    FontSize="16"
                                    FontAttributes="Bold"/>
                                <Label Text="{Binding Description}"
                                    FontSize="12"
                                    TextColor="Gray"
                                    LineBreakMode="TailTruncation"
                                    MaxLines="1"/>
                            </StackLayout>

                            <StackLayout Grid.Column="2"
                                VerticalOptions="Center">
                                <Label Text="{Binding CreatedDate, StringFormat='{0:dd.MM.yyyy}'}"
                                    FontSize="12"
                                    TextColor="Gray"/>
                                <Label Text="{Binding IsActive, Converter={StaticResource ActiveStatusConverter}}"
                                    FontSize="11"
                                    TextColor="{Binding IsActive, Converter={StaticResource ActiveColorConverter}}"/>
                            </StackLayout>

                            <VerticalStackLayout Grid.Column="3"
                                VerticalOptions="Center"
                                Spacing="5">
                                <ImageButton Source="edit.png"
                                    HeightRequest="30"
                                    WidthRequest="30"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CustomersViewModel}}, 
                                                    Path=EditCustomerCommand}"
                                    CommandParameter="{Binding .}"/>
                                <ImageButton Source="delete.png"
                                    HeightRequest="30"
                                    WidthRequest="30"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CustomersViewModel}}, 
                                                    Path=DeleteCustomerCommand}"
                                    CommandParameter="{Binding .}"/>
                            </VerticalStackLayout>

                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <Button Grid.Row="2"
            Text="Добавить клиента"
            Command="{Binding AddCustomerCommand}"
            BackgroundColor="#2b0b98"
            TextColor="White"
            CornerRadius="10"
            HeightRequest="50"
            FontSize="16"/>

    </Grid>
</ContentPage>