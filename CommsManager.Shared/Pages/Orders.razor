@page "/orders"
@page "/"
@using CommsManager.Shared.Models
@using CommsManager.Shared.Services
@inject MockDataService DataService

<PageTitle>Заказы - CommsManager</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Мои заказы</h1>
        <button class="btn btn-primary" @onclick="ShowAddOrderModal">
            <i class="bi bi-plus-circle"></i> Новый заказ
        </button>
    </div>

    @if (!_orders.Any())
    {
        <div class="alert alert-info">
            <h4>Пока нет заказов</h4>
            <p>Создайте ваш первый заказ, нажав кнопку "Новый заказ"</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Клиент</th>
                        <th>Цена</th>
                        <th>Срок</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in _orders)
                    {
                        <tr>
                            <td>@order.Title</td>
                            <td>
                                <div>@order.CustomerName</div>
                                <small class="text-muted">@order.CustomerEmail</small>
                            </td>
                            <td>@order.Price.ToString("N0") ₽</td>
                            <td>
                                <span class="@GetDeadlineClass(order.Deadline)">
                                    @order.Deadline.ToString("dd.MM.yyyy")
                                </span>
                            </td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(order.Status)">
                                    @GetStatusText(order.Status)
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" @onclick="() => EditOrder(order)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteOrder(order.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Всего заказов</h5>
                        <p class="card-text display-6">@_orders.Count</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Активные</h5>
                        <p class="card-text display-6">@DataService.GetActiveOrdersCount()</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Общий доход</h5>
                        <p class="card-text display-6">@DataService.GetTotalRevenue().ToString("N0") ₽</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@if (_showModal)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(_editingOrder?.Id == Guid.Empty ? "Новый заказ" : "Редактирование заказа")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@_editingOrder" OnValidSubmit="SaveOrder">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">Название заказа *</label>
                            <InputText @bind-Value="@_editingOrder.Title" class="form-control" />
                            <ValidationMessage For="@(() => _editingOrder.Title)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Описание *</label>
                            <InputTextArea @bind-Value="@_editingOrder.Description" class="form-control" rows="3" />
                            <ValidationMessage For="@(() => _editingOrder.Description)" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Имя клиента *</label>
                                <InputText @bind-Value="@_editingOrder.CustomerName" class="form-control" />
                                <ValidationMessage For="@(() => _editingOrder.CustomerName)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email клиента</label>
                                <InputText @bind-Value="@_editingOrder.CustomerEmail" class="form-control" />
                                <ValidationMessage For="@(() => _editingOrder.CustomerEmail)" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Цена (₽) *</label>
                                <InputNumber @bind-Value="@_editingOrder.Price" class="form-control" />
                                <ValidationMessage For="@(() => _editingOrder.Price)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Срок выполнения *</label>
                                <InputDate @bind-Value="@_editingOrder.Deadline" class="form-control" />
                                <ValidationMessage For="@(() => _editingOrder.Deadline)" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Статус</label>
                            <InputSelect @bind-Value="@_editingOrder.Status" class="form-select">
                                <option value="@OrderStatus.New">Новый</option>
                                <option value="@OrderStatus.InProgress">В работе</option>
                                <option value="@OrderStatus.ReadyForReview">Готов к проверке</option>
                                <option value="@OrderStatus.Completed">Завершен</option>
                                <option value="@OrderStatus.Cancelled">Отменен</option>
                            </InputSelect>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">Отмена</button>
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Order> _orders = new();
    private bool _showModal = false;
    private Order? _editingOrder;

    protected override void OnInitialized()
    {
        _orders = DataService.GetOrders();
    }

    private void ShowAddOrderModal()
    {
        _editingOrder = new Order();
        _showModal = true;
    }

    private void EditOrder(Order order)
    {
        _editingOrder = new Order
        {
            Id = order.Id,
            Title = order.Title,
            Description = order.Description,
            CustomerName = order.CustomerName,
            CustomerEmail = order.CustomerEmail,
            Price = order.Price,
            Deadline = order.Deadline,
            Status = order.Status
        };
        _showModal = true;
    }

    private void SaveOrder()
    {
        if (_editingOrder == null) return;

        if (_editingOrder.Id == Guid.Empty)
        {
            DataService.AddOrder(_editingOrder);
        }
        else
        {
            DataService.UpdateOrder(_editingOrder);
        }

        _orders = DataService.GetOrders();
        CloseModal();
    }

    private void DeleteOrder(Guid id)
    {
        var order = _orders.FirstOrDefault(o => o.Id == id);
        if (order != null)
        {
            order.Status = OrderStatus.Cancelled;
            DataService.UpdateOrder(order);
            _orders = DataService.GetOrders();
        }
    }

    private void CloseModal()
    {
        _showModal = false;
        _editingOrder = null;
    }

    private string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.New => "bg-primary",
            OrderStatus.InProgress => "bg-warning",
            OrderStatus.ReadyForReview => "bg-info",
            OrderStatus.Completed => "bg-success",
            OrderStatus.Cancelled => "bg-secondary",
            _ => "bg-light"
        };
    }

    private string GetStatusText(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.New => "Новый",
            OrderStatus.InProgress => "В работе",
            OrderStatus.ReadyForReview => "На проверке",
            OrderStatus.Completed => "Завершен",
            OrderStatus.Cancelled => "Отменен",
            _ => "Неизвестно"
        };
    }

    private string GetDeadlineClass(DateTime deadline)
    {
        if (deadline < DateTime.Now)
            return "text-danger fw-bold";
        if (deadline < DateTime.Now.AddDays(3))
            return "text-warning fw-bold";
        return "text-dark";
    }
}