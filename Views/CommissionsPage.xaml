<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:components="clr-namespace:CommsManager.Views.Components"
             xmlns:vm="clr-namespace:CommsManager.ViewModels"
             xmlns:enums="clr-namespace:CommsManager.Models.Enums"
             xmlns:models="clr-namespace:CommsManager.Models"
             x:Class="CommsManager.Views.CommissionsPage"
             Title="Комиссии"
             x:DataType="vm:CommissionsViewModel">
    
    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsEnabled="False" IsVisible="False" />
    </Shell.BackButtonBehavior>

    <Grid RowDefinitions="Auto,*,Auto">
        <Grid ColumnDefinitions="*,Auto" 
              RowDefinitions="Auto,Auto"
              Padding="16,8"
              BackgroundColor="{StaticResource SystemAltMediumHighColor}">
            
            <SearchBar Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                       Placeholder="Поиск комиссий..."
                       Text="{Binding SearchText}"
                       Style="{StaticResource FluentSearchBarStyle}" />

            <Picker Grid.Row="1" Grid.Column="0"
                    Title="Статус"
                    ItemsSource="{Binding StatusFilters}"
                    SelectedItem="{Binding SelectedStatusFilter}"
                    Style="{StaticResource FluentPickerStyle}"
                    Margin="0,8,4,0" />

            <Picker Grid.Row="1" Grid.Column="1"
                    Title="Сортировка"
                    ItemsSource="{Binding SortOptions}"
                    SelectedItem="{Binding SelectedSortOption}"
                    Style="{StaticResource FluentPickerStyle}"
                    Margin="4,8,0,0" />
        </Grid>

        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding LoadCommissionsCommand}">
            
            <CollectionView ItemsSource="{Binding FilteredCommissions}"
                            SelectionMode="None"
                            EmptyView="Нет комиссий">
                
                <CollectionView.Header>
                    <StackLayout Padding="16,8">
                        <Label Text="{Binding CommissionsCount, StringFormat='Всего комиссий: {0}'}"
                               Style="{StaticResource BodyMediumLabelStyle}" />
                    </StackLayout>
                </CollectionView.Header>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Commission">
                        <components:CommissionCard Commission="{Binding .}">
                            <components:CommissionCard.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CommissionsViewModel}}, Path=SelectCommissionCommand}"
                                                      CommandParameter="{Binding .}" />
                            </components:CommissionCard.GestureRecognizers>
                        </components:CommissionCard>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <Border Grid.Row="2"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="16"
                WidthRequest="56"
                HeightRequest="56"
                Background="{StaticResource SystemAccentColor}">
            
            <Border.Shadow>
                <Shadow Brush="{StaticResource SystemAccentColor}"
                        Offset="0,4"
                        Radius="8"
                        Opacity="0.3" />
            </Border.Shadow>

            <Button ImageSource="add_white.png"
                    Command="{Binding CreateCommissionCommand}"
                    BackgroundColor="Transparent"
                    WidthRequest="56"
                    HeightRequest="56"
                    CornerRadius="28" />
        </Border>

    </Grid>
</ContentPage>