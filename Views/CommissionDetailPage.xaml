<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CommsManager.ViewModels"
             xmlns:enums="clr-namespace:CommsManager.Models.Enums"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="CommsManager.Views.CommissionDetailPage"
             Title="{Binding Title}"
             x:DataType="vm:CommissionDetailViewModel">
    
    <ScrollView>
        <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
              Padding="16"
              RowSpacing="16">
            
            <Frame Grid.Row="0" Style="{StaticResource CardFrameStyle}" Padding="16">
                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                    
                    <Entry Grid.Row="0" Grid.Column="0"
                           Text="{Binding Commission.Title}"
                           Placeholder="Название комиссии*"
                           Style="{StaticResource FluentEntryStyle}"
                           FontSize="18"
                           FontAttributes="Bold" />
                    
                    <Picker Grid.Row="0" Grid.Column="1"
                            ItemsSource="{Binding StatusOptions}"
                            SelectedItem="{Binding Commission.Status}"
                            Title="Статус"
                            Style="{StaticResource FluentPickerStyle}"
                            WidthRequest="120" />
                    
                    <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                          ColumnDefinitions="Auto,*" ColumnSpacing="8">
                        <Label Text="Заказчик:*"
                               Style="{StaticResource BodyMediumLabelStyle}"
                               VerticalOptions="Center" />
                        <Picker Grid.Column="1"
                                ItemsSource="{Binding Customers}"
                                ItemDisplayBinding="{Binding Name}"
                                SelectedItem="{Binding SelectedCustomer}"
                                Title="Выберите заказчика"
                                Style="{StaticResource FluentPickerStyle}" />
                    </Grid>
                    
                    <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                          ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                        <Label Text="Приоритет:"
                               Style="{StaticResource BodyMediumLabelStyle}"
                               VerticalOptions="Center" />
                        <Slider Grid.Column="1"
                                Minimum="0"
                                Maximum="10"
                                Value="{Binding Commission.Priority}"
                                ThumbColor="{StaticResource SystemAccentColor}"
                                MinimumTrackColor="{StaticResource SystemAccentColor}" />
                        <Label Grid.Column="2"
                               Text="{Binding Commission.Priority}"
                               Style="{StaticResource BodyMediumLabelStyle}"
                               WidthRequest="30"/>
                    </Grid>
                </Grid>
            </Frame>

            <Frame Grid.Row="1" Style="{StaticResource CardFrameStyle}" Padding="16">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Описание"
                           Style="{StaticResource TitleSmallLabelStyle}" />
                    <Editor Text="{Binding Commission.Description}"
                            Placeholder="Описание работы..."
                            AutoSize="TextChanges"
                            MinimumHeightRequest="80"
                            Style="{StaticResource FluentEditorStyle}" />
                </VerticalStackLayout>
            </Frame>

            <Frame Grid.Row="2" Style="{StaticResource CardFrameStyle}" Padding="16">
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" RowSpacing="12" ColumnSpacing="12">
                    
                    <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                        <Label Text="Тип арта"
                               Style="{StaticResource BodyMediumLabelStyle}" />
                        <Picker ItemsSource="{Binding ArtTypeOptions}"
                                SelectedItem="{Binding Commission.ArtType}"
                                Style="{StaticResource FluentPickerStyle}" />
                    </VerticalStackLayout>
                    
                    <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                        <Label Text="Цена"
                               Style="{StaticResource BodyMediumLabelStyle}" />
                        <Entry Text="{Binding Commission.Price}"
                               Keyboard="Numeric"
                               Placeholder="0.00"
                               Style="{StaticResource FluentEntryStyle}" />
                    </VerticalStackLayout>
                    
                    <VerticalStackLayout Grid.Row="1" Grid.Column="0" Spacing="4">
                        <Label Text="Аванс"
                               Style="{StaticResource BodyMediumLabelStyle}" />
                        <Entry Text="{Binding Commission.AdvancePayment}"
                               Keyboard="Numeric"
                               Placeholder="0.00"
                               Style="{StaticResource FluentEntryStyle}" />
                    </VerticalStackLayout>
                    
                    <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="4"
                                         VerticalOptions="End">
                        <CheckBox IsChecked="{Binding Commission.IsPaid}"
                                  Color="{StaticResource SystemAccentColor}"
                                  VerticalOptions="Center" />
                        <Label Text="Оплачено"
                               Style="{StaticResource BodyMediumLabelStyle}"
                               VerticalOptions="Center" />
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <Frame Grid.Row="3" Style="{StaticResource CardFrameStyle}" Padding="16">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Дедлайн"
                           Style="{StaticResource TitleSmallLabelStyle}" />
                    
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                        <DatePicker Date="{Binding Commission.Deadline, TargetNullValue=''}"
                                    MinimumDate="{Binding Today}"
                                    Style="{StaticResource FluentDatePickerStyle}" />
                        
                        <Button Grid.Column="1"
                                Text="Очистить"
                                Command="{Binding ClearDeadlineCommand}"
                                Style="{StaticResource TextButtonStyle}"
                                VerticalOptions="Center" />
                    </Grid>
                    
                    <Label Text="{Binding DaysUntilDeadline, StringFormat='Дней до дедлайна: {0}'}"
                           Style="{StaticResource BodySmallLabelStyle}"
                           TextColor="{Binding DeadlineColor}" />
                </VerticalStackLayout>
            </Frame>

            <Frame Grid.Row="4" Style="{StaticResource CardFrameStyle}" Padding="16">
                <VerticalStackLayout Spacing="12">
                    <Label Text="Работы"
                           Style="{StaticResource TitleSmallLabelStyle}" />
                    
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Эскиз"
                               Style="{StaticResource BodyMediumLabelStyle}" />
                        
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Button Text="Загрузить эскиз"
                                    Command="{Binding UploadSketchCommand}"
                                    Style="{StaticResource OutlinedButtonStyle}" />
                            
                            <Button Grid.Column="1"
                                    Text="Просмотр"
                                    Command="{Binding ViewSketchCommand}"
                                    IsEnabled="{Binding HasSketch}"
                                    Style="{StaticResource TextButtonStyle}" />
                        </Grid>
                        
                        <Image Source="{Binding SketchImage}"
                               Aspect="AspectFit"
                               HeightRequest="150"
                               IsVisible="{Binding HasSketch}" />
                    </VerticalStackLayout>
                    
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Финальная работа"
                               Style="{StaticResource BodyMediumLabelStyle}" />
                        
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Button Text="Загрузить финальную работу"
                                    Command="{Binding UploadFinalArtCommand}"
                                    Style="{StaticResource OutlinedButtonStyle}" />
                            
                            <Button Grid.Column="1"
                                    Text="Просмотр"
                                    Command="{Binding ViewFinalArtCommand}"
                                    IsEnabled="{Binding HasFinalArt}"
                                    Style="{StaticResource TextButtonStyle}" />
                        </Grid>
                        
                        <Image Source="{Binding FinalArtImage}"
                               Aspect="AspectFit"
                               HeightRequest="150"
                               IsVisible="{Binding HasFinalArt}" />
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <Frame Grid.Row="5" Style="{StaticResource CardFrameStyle}" Padding="16">
                <VerticalStackLayout Spacing="12">
                    <Label Text="Теги"
                           Style="{StaticResource TitleSmallLabelStyle}" />
                    
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                        <Entry Text="{Binding NewTag}"
                               Placeholder="Добавить тег..."
                               Style="{StaticResource FluentEntryStyle}" />
                        
                        <Button Grid.Column="1"
                                Text="Добавить"
                                Command="{Binding AddTagCommand}"
                                Style="{StaticResource OutlinedButtonStyle}" />
                    </Grid>
                    
                    <FlexLayout BindableLayout.ItemsSource="{Binding Commission.Tags}"
                                Wrap="Wrap"
                                AlignItems="Start">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource SystemAccentColor}"
                                        Padding="8,4"
                                        Margin="0,0,4,4">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="4">
                                        <Label Text="{Binding Tag.Name}"
                                               TextColor="White"
                                               Style="{StaticResource CaptionLabelStyle}" />
                                        <Button Grid.Column="1"
                                                Text="×"
                                                TextColor="White"
                                                FontSize="10"
                                                BackgroundColor="Transparent"
                                                Padding="0"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CommissionDetailViewModel}}, Path=RemoveTagCommand}"
                                                CommandParameter="{Binding .}" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </VerticalStackLayout>
            </Frame>

            <Frame Grid.Row="6" Style="{StaticResource CardFrameStyle}" Padding="16">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Заметки"
                           Style="{StaticResource TitleSmallLabelStyle}" />
                    <Editor Text="{Binding Commission.Notes}"
                            Placeholder="Дополнительные заметки..."
                            AutoSize="TextChanges"
                            MinimumHeightRequest="60"
                            Style="{StaticResource FluentEditorStyle}" />
                </VerticalStackLayout>
            </Frame>

            <Grid Grid.Row="7" ColumnDefinitions="*,*" ColumnSpacing="12">
                <Button Text="Сохранить"
                        Command="{Binding SaveCommissionCommand}"
                        Style="{StaticResource PrimaryButtonStyle}" />
                
                <Button Grid.Column="1"
                        Text="Удалить"
                        Command="{Binding DeleteCommissionCommand}"
                        IsVisible="{Binding IsExistingCommission}"
                        Style="{StaticResource DangerButtonStyle}" />
            </Grid>

        </Grid>
    </ScrollView>
</ContentPage>